<?xml version="1.0" encoding="UTF-8" ?><root><title type="str">Azure AD Health Service Agents Registry Keys Access</title><id type="str">1d2ab8ac-1a01-423b-9c39-001510eae8e8</id><status type="str">test</status><description type="str">This detection uses Windows security events to detect suspicious access attempts to the registry key values and sub-keys of Azure AD Health service agents (e.g AD FS).
Information from AD Health service agents can be used to potentially abuse some of the features provided by those services in the cloud (e.g. Federation).
This detection requires an access control entry (ACE) on the system access control list (SACL) of the following securable object: HKLM:\SOFTWARE\Microsoft\ADHealthAgent.
Make sure you set the SACL to propagate to its sub-keys.
</description><references type="list"><item type="str">https://o365blog.com/post/hybridhealthagent/</item><item type="str">https://github.com/OTRF/Set-AuditRule/blob/c3dec5443414231714d850565d364ca73475ade5/rules/registry/aad_connect_health_service_agent.yml</item></references><author type="str">Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research), MSTIC</author><date type="str">2021/08/26</date><modified type="str">2022/10/09</modified><tags type="list"><item type="str">attack.discovery</item><item type="str">attack.t1012</item></tags><logsource type="dict"><product type="str">windows</product><service type="str">security</service></logsource><detection type="dict"><selection type="dict"><EventID type="list"><item type="int">4656</item><item type="int">4663</item></EventID><ObjectType type="str">Key</ObjectType><ObjectName type="str">\REGISTRY\MACHINE\SOFTWARE\Microsoft\ADHealthAgent</ObjectName></selection><filter type="dict"><key name="ProcessName|contains" type="list"><item type="str">Microsoft.Identity.Health.Adfs.DiagnosticsAgent.exe</item><item type="str">Microsoft.Identity.Health.Adfs.InsightsService.exe</item><item type="str">Microsoft.Identity.Health.Adfs.MonitoringAgent.Startup.exe</item><item type="str">Microsoft.Identity.Health.Adfs.PshSurrogate.exe</item><item type="str">Microsoft.Identity.Health.Common.Clients.ResourceMonitor.exe</item></key></filter><condition type="str">selection and not filter</condition></detection><falsepositives type="list"><item type="str">Unknown</item></falsepositives><level type="str">medium</level></root>