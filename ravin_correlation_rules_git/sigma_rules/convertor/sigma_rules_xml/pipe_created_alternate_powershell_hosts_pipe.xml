<?xml version="1.0" encoding="UTF-8" ?><root><title type="str">Alternate PowerShell Hosts Pipe</title><id type="str">58cb02d5-78ce-4692-b3e1-dce850aae41a</id><status type="str">test</status><description type="str">Detects alternate PowerShell hosts potentially bypassing detections looking for powershell.exe</description><references type="list"><item type="str">https://threathunterplaybook.com/hunts/windows/190610-PwshAlternateHosts/notebook.html</item><item type="str">https://threathunterplaybook.com/hunts/windows/190410-LocalPwshExecution/notebook.html</item></references><author type="str">Roberto Rodriguez @Cyb3rWard0g, Tim Shelton</author><date type="str">2019/09/12</date><modified type="str">2022/10/10</modified><tags type="list"><item type="str">attack.execution</item><item type="str">attack.t1059.001</item></tags><logsource type="dict"><product type="str">windows</product><category type="str">pipe_created</category><definition type="str">Note that you have to configure logging for Named Pipe Events in Sysmon config (Event ID 17 and Event ID 18). The basic configuration is in popular sysmon configuration (https://github.com/SwiftOnSecurity/sysmon-config), but it is worth verifying. You can also use other repo, e.g. https://github.com/Neo23x0/sysmon-config, https://github.com/olafhartong/sysmon-modular. How to test detection? You can check powershell script from this site https://svch0st.medium.com/guide-to-named-pipes-and-hunting-for-cobalt-strike-pipes-dc46b2c5f575</definition></logsource><detection type="dict"><selection type="dict"><key name="PipeName|startswith" type="str">\PSHost</key></selection><filter1 type="dict"><key name="Image|endswith" type="list"><item type="str">\powershell.exe</item><item type="str">\powershell_ise.exe</item><item type="str">\WINDOWS\System32\sdiagnhost.exe</item><item type="str">\WINDOWS\System32\wsmprovhost.exe</item><item type="str">\Windows\system32\dsac.exe</item><item type="str">\Windows\system32\wbem\wmiprvse.exe</item><item type="str">\ForefrontActiveDirectoryConnector.exe</item><item type="str">c:\windows\system32\inetsrv\w3wp.exe</item></key></filter1><filter2 type="dict"><Image type="null"></Image></filter2><filter3 type="dict"><key name="Image|contains|all" type="list"><item type="str">:\Program Files</item><item type="str">\Microsoft SQL Server\</item></key><key name="Image|endswith" type="str">\Tools\Binn\SQLPS.exe</key></filter3><filter4 type="dict"><key name="Image|startswith" type="list"><item type="str">C:\Program Files\Citrix\</item><item type="str">C:\Program Files\Microsoft\Exchange Server\</item></key></filter4><filter5 type="dict"><Image type="list"><item type="str">C:\Windows\system32\ServerManager.exe</item><item type="str">C:\Program Files\PowerShell\7\pwsh.exe</item></Image></filter5><condition type="str">selection and not 1 of filter*</condition></detection><fields type="list"><item type="str">ComputerName</item><item type="str">User</item><item type="str">Image</item><item type="str">PipeName</item></fields><falsepositives type="list"><item type="str">Programs using PowerShell directly without invocation of a dedicated interpreter.</item></falsepositives><level type="str">medium</level></root>