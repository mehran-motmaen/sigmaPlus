<?xml version="1.0" encoding="UTF-8" ?><root><title type="str">ADFS Database Named Pipe Connection</title><id type="str">1ea13e8c-03ea-409b-877d-ce5c3d2c1cb3</id><status type="str">test</status><description type="str">Detects suspicious local connections via a named pipe to the AD FS configuration database (Windows Internal Database).
Used to access information such as the AD FS configuration settings which contains sensitive information used to sign SAML tokens.
</description><references type="list"><item type="str">https://github.com/Azure/Azure-Sentinel/blob/f99542b94afe0ad2f19a82cc08262e7ac8e1428e/Detections/SecurityEvent/ADFSDBNamedPipeConnection.yaml</item><item type="str">https://o365blog.com/post/adfs/</item><item type="str">https://github.com/Azure/SimuLand</item></references><author type="str">Roberto Rodriguez @Cyb3rWard0g</author><date type="str">2021/10/08</date><modified type="str">2023/04/20</modified><tags type="list"><item type="str">attack.collection</item><item type="str">attack.t1005</item></tags><logsource type="dict"><product type="str">windows</product><category type="str">pipe_created</category><definition type="str">Note that you have to configure logging for Named Pipe Events in Sysmon config (Event ID 17 and Event ID 18). The basic configuration is in popular sysmon configuration (https://github.com/SwiftOnSecurity/sysmon-config), but it is worth verifying. You can also use other repo, e.g. https://github.com/Neo23x0/sysmon-config, https://github.com/olafhartong/sysmon-modular. How to test detection? You can check powershell script from this site https://svch0st.medium.com/guide-to-named-pipes-and-hunting-for-cobalt-strike-pipes-dc46b2c5f575</definition></logsource><detection type="dict"><selection type="dict"><PipeName type="str">\MICROSOFT##WID\tsql\query</PipeName></selection><filter type="dict"><key name="Image|endswith" type="list"><item type="str">\Microsoft.IdentityServer.ServiceHost.exe</item><item type="str">\Microsoft.Identity.Health.Adfs.PshSurrogate.exe</item><item type="str">\AzureADConnect.exe</item><item type="str">\Microsoft.Tri.Sensor.exe</item><item type="str">\wsmprovhost.exe</item><item type="str">\mmc.exe</item><item type="str">\sqlservr.exe</item><item type="str">\tssdis.exe</item><item type="str">C:\Windows\system32\svchost.exe</item></key></filter><condition type="str">selection and not filter</condition></detection><falsepositives type="list"><item type="str">Processes in the filter condition</item></falsepositives><level type="str">high</level></root>